# whitted风格光线追踪

![image-20241111154816913](assets/image-20241111154816913-20250209174405-cx8baun.png)

# 光线追踪

## 基于三个idea

- 光直线传播
- 光线之间不会发生碰撞
- 光路的可逆性

![image-20241111162147891](assets/image-20241111162147891-20250209174405-dh6kocm.png)

# Whitted风格的光线追踪

![image-20241111170949430](assets/image-20241111170949430-20250209174405-bnt91sm.png)

- 将所有能够照亮的点累加起来（假设是blin-phong模型）得到最后的像素值
- 每一次的折射都会使能量损耗

![image-20241111171248552](assets/image-20241111171248552-20250209174405-ylkkxi7.png)

## 光线求交

- 隐式表面，解出t，根据t的解确定交点和有无相交

![image-20241111171527069](assets/image-20241111171527069-20250209174405-1r2xrbb.png)

- 网格求交

1、通过三角面确定一个平面（点法式）：

![image-20241111173002614](assets/image-20241111173002614-20250209174405-kmdhghz.png)

展开

![image-20241111173120816](assets/image-20241111173120816-20250209174405-ejungdw.png)

2、光线和平面的交点

![image-20241111173228424](assets/image-20241111173228424-20250209174405-auvrq8z.png)

3、判断交点是否再三角面内

另一种解法：

t和b是未知的，但可以由线性方程组解，其中，解需要验证（非负）

![image-20241111173520206](assets/image-20241111173520206-20250209174405-o85zkiv.png)

- 网格物体求交

与一个物体的所有三角面计算求交（很慢）

## 加速结构

### 包围盒

#### AABB 包围盒求交

2维情况下，三维同

![image-20241112091633324](assets/image-20241112091633324-20250209174405-i9rckzd.png)

- 光线进入所有对面才进入盒子
- 任意光线离开对面光线就已经离开盒子
- 因此取所有对面的交集

怎么判断求交：

![image-20241112092203948](assets/image-20241112092203948-20250209174405-tsuwf1p.png)

![image-20241112092330072](assets/image-20241112092330072-20250209174405-48r6nn0.png)

总的来说，条件为

![image-20241112092404558](assets/image-20241112092404558-20250209174405-luht1z9.png)

轴对齐的平面求交可以简化为：

![image-20241112092817725](assets/image-20241112092817725-20250209174405-xa1cbnm.png)

#### 包围盒预处理

##### 把大的AABB划分成小的AABB

预处理 ——划分包围盒为一个个小盒子，标记拥有物体的盒子

![image-20241112093544429](assets/image-20241112093544429-20250209174405-rx6msmf.png)

光线与小盒子求交

![image-20241112093651847](assets/image-20241112093651847-20250209174405-9459tog.png)

划分成多少格子效率比较高

![image-20241112094206923](assets/image-20241112094206923-20250209174405-umzfg4i.png)

### 空间划分——包围盒的另一种预处理

八叉树的缺点在于节点的数量随着维度的上升而呈指数级上升，BSP基本不考虑，因为不是AABB的

![image-20241112094837455](assets/image-20241112094837455-20250209174405-31jg2y5.png)

#### KD-Tree预处理

![image-20241112095329174](assets/image-20241112095329174-20250209174405-ozwg9y2.png)

#### KD-Tree求交

![image-20241112095802017](assets/image-20241112095802017-20250209174405-h5cqnpu.png)

- 光线与包围盒求交
- 光线与最上层两1、B求交
- 1节点已经是叶子节点，与1节点所有物体求交
- 与B节点相交，继续看B的子节点2、C
- ...

#### KD-Tree的缺点

预处理过程中，需要把物体放在某个节点之下，需要判断物体（的三角形）是否与盒子相交，但

- KD-Tree很难判定物体和节点有交点
- 且同一个物体可能出现在不同的节点

### 物体划分BVH

把三角形分为两堆，分别求包围盒

![image-20241112101758767](assets/image-20241112101758767-20250209174405-ihny9yt.png)

#### 如何划分子节点

1、学习KD-Tree，每次选择不同的轴

2、最长轴法

3、取重心坐标，每次沿xyz找中间的三角形，会使得树更加平衡——快速选择算法O(n)

#### 划分结束

![image-20241112102904776](assets/image-20241112102904776-20250209174405-u9e2dbd.png)

### 伪代码

![image-20241112103049286](assets/image-20241112103049286-20250209174405-e2b4gd9.png)
